<!-- public/kanri.html -->
<!DOCTYPE html>
<html lang="ja">
<head>
<meta charset="utf-8"/><meta name="viewport" content="width=device-width,initial-scale=1">
<title>管理画面</title>
<style>
  body{font-family:Arial;margin:20px}
  table{border-collapse:collapse;width:100%}
  th,td{border:1px solid #ddd;padding:8px}
  th{background:#f2f2f2}
  button{margin-right:6px}
</style>
</head>
<body>
  <h1>管理ダッシュボード</h1>
  <div>
    <label>認証方式:
      <select id="authMode">
        <option value="free">自由登録</option>
        <option value="approval">管理承認式</option>
      </select>
      <button id="setAuth">設定反映</button>
    </label>
  </div>

  <h2>ユーザー一覧</h2>
  <table id="usersTable">
    <thead><tr><th>ID</th><th>ユーザー名</th><th>機種番号</th><th>役割</th><th>BAN</th><th>操作</th></tr></thead>
    <tbody></tbody>
  </table>

<script>
async function api(path, opts={}) {
  const res = await fetch(path, opts);
  return res.json();
}

async function loadUsers() {
  const data = await api('/api/users');
  const tbody = document.querySelector('#usersTable tbody');
  tbody.innerHTML = '';
  data.users.forEach(u => {
    const tr = document.createElement('tr');
    tr.innerHTML = `<td>${u.id}</td>
      <td>${u.username}</td>
      <td>${u.device_code}</td>
      <td>${u.role}</td>
      <td>${u.is_banned ? u.ban_type || 'normal' : ''}</td>
      <td>
        <button onclick="doBan(${u.id}, 'normal')">BAN</button>
        <button onclick="doBan(${u.id}, 'plus')">BAN+</button>
        <button onclick="doBan(${u.id}, 'unban')">UNBAN</button>
      </td>`;
    tbody.appendChild(tr);
  });
}

async function doBan(id, type) {
  const ok = confirm(`ユーザー ${id} に対して ${type} を実行しますか？`);
  if (!ok) return;
  const body = type==='unban' ? { type: 'unban' } : { type: type };
  const res = await api(`/api/users/${id}/ban`, { method: 'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify(body)});
  if (res.ok) { alert('成功'); loadUsers(); } else alert(res.error || '失敗');
}

document.getElementById('setAuth').addEventListener('click', async () => {
  const mode = document.getElementById('authMode').value;
  const res = await api('/api/settings/auth-mode', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({mode})});
  if (res.ok) alert('設定更新: ' + res.mode);
});

loadUsers();
</script>
</body>
</html>
